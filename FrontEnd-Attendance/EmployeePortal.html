<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Dashboard</title>
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 25%, #3d6db8 50%, #4a7bc8 75%, #5a8fd8 100%);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow-x: hidden;
}

body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
        radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(120, 119, 198, 0.2) 0%, transparent 50%);
    pointer-events: none;
    z-index: -1;
}

.header {
    /* background: rgba(255, 255, 255, 0.95); */
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); 
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    padding: 20px 40px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    z-index: 100;
}

.logo-container {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
}

.logo {
    height: 60px;
    width: auto;
    filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
}

.logout-btn {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
    border: none;
    width: 60px;
    height: 60px;
    border-radius: 18px;
    color: white;
    font-size: 22px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
    border: 2px solid transparent;
}

.logout-btn:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 15px 35px rgba(255, 107, 107, 0.4);
    border-color: rgba(255, 255, 255, 0.2);
}

.logout-btn:active {
    transform: translateY(-1px) scale(0.98);
}

.logout-btn:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.5);
}

.logout-icon {
    position: relative;
    z-index: 2;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
}

.logout-icon svg {
    width: 24px;
    height: 24px;
    fill: currentColor;
}

.tooltip {
    position: absolute;
    bottom: -45px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 14px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}

.tooltip::before {
    content: '';
    position: absolute;
    top: -5px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 5px solid transparent;
    border-right: 5px solid transparent;
    border-bottom: 5px solid rgba(0, 0, 0, 0.8);
}

.logout-btn:hover .tooltip {
    opacity: 1;
}


.main-container {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 30px 20px;
    max-width: 1000px;
    margin: 0 auto;
    width: 100%;
}

.dashboard-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 32px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    padding: 50px;
    box-shadow: 
        0 25px 50px rgba(0, 0, 0, 0.15),
        0 0 0 1px rgba(255, 255, 255, 0.1);
    width: 100%;
    max-width: 900px;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.dashboard-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.8), transparent);
}

.profile-section {
    margin-bottom: 40px;
    position: relative;
}

.profile-image {
    width: 140px;
    height: 140px;
    border-radius: 50%;
    object-fit: cover;
    border: 4px solid transparent;
    background: linear-gradient(135deg, #667eea, #764ba2);
    padding: 4px;
    box-shadow: 
        0 20px 40px rgba(102, 126, 234, 0.3),
        0 0 0 1px rgba(255, 255, 255, 0.1);
    margin-bottom: 25px;
    transition: all 0.3s ease;
    position: relative;
}

.profile-image:hover {
    transform: scale(1.05);
    box-shadow: 
        0 25px 50px rgba(102, 126, 234, 0.4),
        0 0 0 1px rgba(255, 255, 255, 0.2);
}

.employee-name {
    font-size: 42px;
    font-weight: 700;
    background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 20px;
    letter-spacing: -0.5px;
    line-height: 1.2;
}

.percentage-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 35px;
    border-radius: 50px;
    font-size: 18px;
    font-weight: 600;
    display: inline-block;
    margin-bottom: 40px;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    position: relative;
    overflow: hidden;
    letter-spacing: 0.5px;
}

.percentage-badge::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.6s;
}

.percentage-badge:hover::before {
    left: 100%;
}

.details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 25px;
    margin-bottom: 40px;
}

.detail-card {
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 20px;
    padding: 30px;
    text-align: left;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.detail-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, #667eea, #764ba2);
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.3s ease;
}

.detail-card:hover::before {
    transform: scaleX(1);
}

.detail-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 40px rgba(102, 126, 234, 0.15);
    background: rgba(255, 255, 255, 0.9);
    border-color: rgba(102, 126, 234, 0.2);
}

.detail-label {
    font-size: 13px;
    font-weight: 600;
    color: #718096;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    margin-bottom: 12px;
    position: relative;
}

.detail-value {
    font-size: 22px;
    font-weight: 700;
    color: #2d3748;
    line-height: 1.3;
    word-break: break-word;
}

.status-card {
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 20px;
    padding: 30px;
    text-align: left;
    margin-bottom: 40px;
    position: relative;
    overflow: hidden;
}

.status-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, #48bb78, #38a169);
}

.status-badge {
    background: linear-gradient(135deg, #ed8936, #dd6b20);
    color: white;
    padding: 12px 24px;
    border-radius: 25px;
    font-size: 14px;
    font-weight: 600;
    display: inline-block;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 4px 15px rgba(237, 137, 54, 0.3);
}

.status-badge.present {
    background: linear-gradient(135deg, #48bb78, #38a169);
    box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
}

.status-badge.absent {
    background: linear-gradient(135deg, #f56565, #e53e3e);
    box-shadow: 0 4px 15px rgba(245, 101, 101, 0.3);
}

.status-badge.late {
    background: linear-gradient(135deg, #ed8936, #dd6b20);
    box-shadow: 0 4px 15px rgba(237, 137, 54, 0.3);
}

.view-attendance-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 18px 50px;
    border-radius: 30px;
    font-size: 18px;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    position: relative;
    overflow: hidden;
}

.view-attendance-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.6s;
}

.view-attendance-btn:hover::before {
    left: 100%;
}

.view-attendance-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
}

.view-attendance-btn:active {
    transform: translateY(-1px);
}

.attendance-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
}

.modal-content {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    margin: 3% auto;
    padding: 40px;
    border-radius: 25px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    width: 95%;
    max-width: 900px;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.close {
    color: #a0aec0;
    float: right;
    font-size: 32px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.close:hover {
    color: #e53e3e;
    background: rgba(229, 62, 62, 0.1);
    transform: scale(1.1);
}

.attendance-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 25px;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
}

.attendance-table th,
.attendance-table td {
    padding: 18px 15px;
    text-align: left;
    border-bottom: 1px solid rgba(229, 231, 235, 0.8);
}

.attendance-table th {
    background: linear-gradient(135deg, #f8fafc, #edf2f7);
    font-weight: 600;
    color: #4a5568;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 13px;
    position: sticky;
    top: 0;
    z-index: 10;
}

.attendance-table tbody tr {
    transition: all 0.2s ease;
}

.attendance-table tbody tr:hover {
    background: rgba(102, 126, 234, 0.05);
    transform: scale(1.01);
}

.time-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 25px;
}

.time-card {
    background: linear-gradient(135deg, #f8fafc, #edf2f7);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 15px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.time-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, #667eea, #764ba2);
}

.time-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(102, 126, 234, 0.15);
    background: linear-gradient(135deg, #ffffff, #f8fafc);
}

.time-label {
    font-size: 12px;
    color: #718096;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
}

.time-value {
    font-size: 18px;
    font-weight: 700;
    color: #2d3748;
}

#statusSummary {
    margin-bottom: 25px;
    padding: 25px;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
    border-radius: 15px;
    border: 1px solid rgba(102, 126, 234, 0.2);
}

#statusSummary h4 {
    margin: 0 0 15px 0;
    color: #2d3748;
    font-size: 18px;
    font-weight: 600;
}

#statusSummary > div:last-child {
    display: flex;
    gap: 25px;
    flex-wrap: wrap;
    font-weight: 500;
}

#statusSummary > div:last-child > div {
    padding: 8px 16px;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 20px;
    font-size: 14px;
    transition: all 0.2s ease;
}

#statusSummary > div:last-child > div:hover {
    background: rgba(255, 255, 255, 0.9);
    transform: translateY(-1px);
}

/* Form Elements Styling */
select, input[type="date"], button {
    padding: 12px 16px;
    border-radius: 12px;
    border: 2px solid rgba(102, 126, 234, 0.3);
    font-size: 14px;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.9);
}

select:focus, input[type="date"]:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

button {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    cursor: pointer;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
}

/* Custom Scrollbar */
::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.1);
    border-radius: 10px;
}

::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #5a67d8, #6b46c1);
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
    .main-container {
        padding: 15px;
    }

    .dashboard-card {
        padding: 30px 25px;
        border-radius: 25px;
    }

    .details-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }

    .employee-name {
        font-size: 32px;
    }

    .header {
        padding: 15px 25px;
    }

    .logo {
        height: 50px;
    }

    .modal-content {
        padding: 25px;
        margin: 5% auto;
        width: 98%;
    }

    .time-info {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }
    
    #statusSummary > div:last-child {
        gap: 15px;
    }
    
    #statusSummary > div:last-child > div {
        font-size: 13px;
        padding: 6px 12px;
    }

    .attendance-table th,
    .attendance-table td {
        padding: 12px 8px;
        font-size: 14px;
    }
}

@media (max-width: 480px) {
    .time-info {
        grid-template-columns: 1fr;
    }
    
    .employee-name {
        font-size: 28px;
    }
    
    .percentage-badge {
        font-size: 16px;
        padding: 12px 25px;
    }
}
    </style>
</head>
<body>
    <div class="header">
        <div style="width: 45px;"></div>
        <div class="logo-container">
            <img src="images/mmw_logo.png" alt="MMW Logo" class="logo">
        </div>
<button class="logout-btn" onclick="handleLogout()" title="Logout">
    <div class="logout-icon">
        <svg viewBox="0 0 24 24">
            <path d="M17,7L15.59,8.41L17.17,10H9V12H17.17L15.59,13.59L17,15L21,11L17,7M4,5H12V3H4A2,2 0 0,0 2,5V19A2,2 0 0,0 4,21H12V19H4V5Z"/>
        </svg>
    </div>
    <div class="tooltip">Logout</div>
</button>
            
        </button>
    </div>

    <div class="main-container">
        <div class="dashboard-card">
            <!-- Profile Section -->
            <div class="profile-section">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'%3E%3Ccircle cx='60' cy='60' r='60' fill='%236366f1'/%3E%3Ccircle cx='60' cy='45' r='18' fill='white'/%3E%3Cpath d='M60 75 Q45 68 30 90 Q30 95 90 95 Q90 90 75 68 Q60 75 60 75' fill='white'/%3E%3C/svg%3E" 
                     alt="Employee Profile" 
                     class="profile-image" 
                     id="profileImage">
                <h1 class="employee-name" id="employeeName">Loading...</h1>
                <div class="percentage-badge">
                    Overall Percentage: <span id="attendancePercentage">Loading...</span>
                </div>
            </div>

            <!-- Details Grid -->
            <div class="details-grid">
                <div class="detail-card">
                    <div class="detail-label">Employee ID</div>
                    <div class="detail-value" id="employeeId">Loading...</div>
                </div>
                <div class="detail-card">
                    <div class="detail-label">Department</div>
                    <div class="detail-value" id="department">Loading...</div>
                </div>
                <div class="detail-card">
                    <div class="detail-label">Designation</div>
                    <div class="detail-value" id="designation">Loading...</div>
                </div>
                <div class="detail-card">
                    <div class="detail-label">User Type</div>
                    <div class="detail-value" id="userType">Loading...</div>
                </div>
                <div class="detail-card">
                    <div class="detail-label">Gender</div>
                    <div class="detail-value" id="gender">Loading...</div>
                </div>
                <div class="detail-card">
                    <div class="detail-label">Email</div>
                    <div class="detail-value" id="email">Loading...</div>
                </div>
            </div>

            <!-- Today's Status -->
            <div class="status-card">
                <div class="detail-label">Today's Status</div>
                <div class="status-badge" id="todayStatus">Loading...</div>
                
                <div class="time-info">
                    <div class="time-card">
                        <div class="time-label">Check In</div>
                        <div class="time-value" id="checkInTime">--:--</div>
                    </div>
                    <div class="time-card">
                        <div class="time-label">Check Out</div>
                        <div class="time-value" id="checkOutTime">--:--</div>
                    </div>
                    <div class="time-card">
                        <div class="time-label">Total Hours</div>
                        <div class="time-value" id="totalHours">--:--</div>
                    </div>
                    <div class="time-card">
                        <div class="time-label">Break Time</div>
                        <div class="time-value" id="breakTime">--:--</div>
                    </div>
                </div>
            </div>

            <!-- View Attendance Button -->
            <button class="view-attendance-btn" onclick="openAttendanceModal()">
                View Attendance
            </button>
        </div>
    </div>

    <!-- Attendance Modal -->
    <div id="attendanceModal" class="attendance-modal">
        <div class="modal-content">
            <span class="close" onclick="closeAttendanceModal()">&times;</span>
            <h2 style="margin-bottom: 20px; color: #1f2937;">Attendance History</h2>
            
            <!-- Filter Section -->
            <div style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <!-- Filter Type Selection -->
                <div>
                    <label for="filterType" style="display: block; margin-bottom: 5px; font-weight: bold;">Filter Type:</label>
                    <select id="filterType" onchange="handleFilterTypeChange()" style="padding: 10px; border-radius: 8px; border: 2px solid #6366f1;">
                        <option value="overall">Overall Attendance</option>
                        <option value="date-range">Date Range</option>
                        <option value="month">Month</option>
                    </select>
                </div>

                <!-- Date Range Filters -->
                <div id="dateRangeFilters" style="display: none; gap: 10px;">
                    <div>
                        <label for="fromDate" style="display: block; margin-bottom: 5px; font-weight: bold;">From Date:</label>
                        <input type="date" id="fromDate" onchange="applyFilter()" style="padding: 10px; border-radius: 8px; border: 2px solid #6366f1;">
                    </div>
                    <div>
                        <label for="toDate" style="display: block; margin-bottom: 5px; font-weight: bold;">To Date:</label>
                        <input type="date" id="toDate" onchange="applyFilter()" style="padding: 10px; border-radius: 8px; border: 2px solid #6366f1;">
                    </div>
                </div>

                <!-- Month Filter -->
                <div id="monthFilter" style="display: none;">
                    <label for="monthSelect" style="display: block; margin-bottom: 5px; font-weight: bold;">Select Month:</label>
                    <select id="monthSelect" onchange="applyFilter()" style="padding: 10px; border-radius: 8px; border: 2px solid #6366f1;">
                        <option value="">Select Month</option>
                    </select>
                </div>

                <!-- Apply Filter Button -->
                <div style="align-self: end;">
                    <button onclick="applyFilter()" style="padding: 10px 20px; background-color: #6366f1; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        Apply Filter
                    </button>
                </div>
            </div>

            <!-- Status Summary -->
            <div id="statusSummary" style="margin-bottom: 20px; padding: 15px; background-color: #f3f4f6; border-radius: 8px;">
                <h4 style="margin: 0 0 10px 0; color: #1f2937;">Status Summary</h4>
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div>Present: <span id="presentCount">0</span></div>
                    <div>Absent: <span id="absentCount">0</span></div>
                    <div>Late: <span id="lateCount">0</span></div>
                    <div>Half Day: <span id="halfdayCount">0</span></div>
                    <div>Permission: <span id="permissionCount">0</span></div>
                    <div>On Duty: <span id="ondutyCount">0</span></div>
                    <div><strong>Percentage: <span id="filteredPercentage">0%</span></strong></div>
                </div>
            </div>

            <table class="attendance-table" id="attendanceTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Check In</th>
                        <th>Check Out</th>
                        <th>Status</th>
                        <th>Reason</th>
                    </tr>
                </thead>
                <tbody id="attendanceTableBody">
                    <!-- Attendance data will be populated here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let allAttendanceData = [];
        let currentEmployeeId = '';
        let todayAttendanceData = [];

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, checking session storage...');
            
            // Check if user is logged in
            const userType = sessionStorage.getItem('usertype');
            const employeeId = sessionStorage.getItem('employeeId');
            
            console.log('User type from session:', userType);
            console.log('Employee ID from session:', employeeId);
            
            if (!employeeId || userType !== 'employee') {
                alert('Please login first as an employee');
                window.location.href = 'index.html';
                return;
            }
            
            loadEmployeeData();
            loadTodayStatus();
            loadAttendanceData();
        });

        // Load employee data - fetch fresh data from backend
        async function loadEmployeeData() {
            console.log('Loading employee data...');
            
            const employeeId = sessionStorage.getItem('employeeId');
            if (!employeeId) {
                console.error('Employee ID not found in session storage');
                return;
            }

            try {
                // Fetch fresh employee data from backend
                const response = await fetch(`https://maxmocattendance-50029336824.development.catalystappsail.in/api/employee/${employeeId}`);
                if (response.ok) {
                    const employeeData = await response.json();
                    console.log('Fresh employee data loaded:', employeeData);
                    
                    currentEmployeeId = employeeData.id;
                    populateEmployeeData(employeeData);
                } else {
                    console.error('Failed to load employee data from backend, using session storage');
                    // Fallback to session storage data
                    loadEmployeeDataFromSession();
                }
            } catch (error) {
                console.error('Error loading employee data from backend:', error);
                // Fallback to session storage data
                loadEmployeeDataFromSession();
            }
        }

        // Fallback method to load from session storage
        function loadEmployeeDataFromSession() {
            console.log('Loading employee data from session storage...');
            
            const employeeData = {
                id: sessionStorage.getItem('employeeId'),
                username: sessionStorage.getItem('employeeName'),
                department: sessionStorage.getItem('department'),
                designation: sessionStorage.getItem('designation'),
                usertype: sessionStorage.getItem('actualUserType') || sessionStorage.getItem('usertype'),
                gender: sessionStorage.getItem('gender'),
                email: sessionStorage.getItem('email'),
                profileImage: sessionStorage.getItem('profileImage')
            };

            console.log('Employee data retrieved from session:', employeeData);
            
            currentEmployeeId = employeeData.id;
            populateEmployeeData(employeeData);
        }

        // Populate employee data on the page
        function populateEmployeeData(data) {
            console.log('Populating employee data on page...');
            
            document.getElementById('employeeName').textContent = data.username || data.name || 'N/A';
            document.getElementById('employeeId').textContent = data.id || 'N/A';
            document.getElementById('userType').textContent = data.usertype || 'N/A';
            document.getElementById('department').textContent = data.department || 'N/A';
            document.getElementById('designation').textContent = data.designation || 'N/A';
            document.getElementById('gender').textContent = data.gender || 'N/A';
            document.getElementById('email').textContent = data.email || 'N/A';

            if (data.profileImage) {
                if (typeof data.profileImage === 'string') {
                    document.getElementById('profileImage').src = 'data:image/jpeg;base64,' + data.profileImage;
                } else {
                    document.getElementById('profileImage').src = 'data:image/jpeg;base64,' + data.profileImage;
                }
            }
            
            console.log('Employee data populated successfully');
        }

        // Load today's status specifically
        async function loadTodayStatus() {
            try {
                console.log('Loading today status...');
                
                if (!currentEmployeeId) {
                    currentEmployeeId = sessionStorage.getItem('employeeId');
                }

                const response = await fetch(`https://maxmocattendance-50029336824.development.catalystappsail.in/api/view-attendance/today`);
                if (response.ok) {
                    const todayData = await response.json();
                    console.log('Today data loaded:', todayData);
                    
                    // Find current employee's data
                    const employeeToday = todayData.find(emp => emp.id === currentEmployeeId);
                    
                    if (employeeToday) {
                        displayTodayStatusFromData(employeeToday);
                    } else {
                        setDefaultTodayValues();
                    }
                } else {
                    console.error('Failed to load today status:', response.status);
                    setDefaultTodayValues();
                }
            } catch (error) {
                console.error('Error loading today status:', error);
                setDefaultTodayValues();
            }
        }

        // Display today's status from today endpoint data
        function displayTodayStatusFromData(todayData) {
            document.getElementById('todayStatus').textContent = todayData.status || 'No Record';
            
            // Set status badge color
            const statusBadge = document.getElementById('todayStatus');
            statusBadge.className = 'status-badge';
            if (todayData.status) {
                const status = todayData.status.toLowerCase();
                if (status === 'present') {
                    statusBadge.classList.add('present');
                } else if (status === 'absent') {
                    statusBadge.classList.add('absent');
                } else if (status === 'late') {
                    statusBadge.classList.add('late');
                }
            }

            // For time details, we need to get from attendance data
            // These will be loaded when attendance data is fetched
        }

        // Load attendance data from backend
        async function loadAttendanceData() {
            try {
                console.log('Loading attendance data for employee:', currentEmployeeId);
                
                if (!currentEmployeeId) {
                    currentEmployeeId = sessionStorage.getItem('employeeId');
                }

                const response = await fetch(`https://maxmocattendance-50029336824.development.catalystappsail.in/api/view-attendance/employee/${currentEmployeeId}`);
                if (response.ok) {
                    const attendanceData = await response.json();
                    console.log('Attendance data loaded:', attendanceData);
                    
                    allAttendanceData = attendanceData;
                    
                    // Load overall percentage
                    loadOverallPercentage();
                    
                    // Display today's time details
                    displayTodayTimeDetails(attendanceData);
                    
                    // Populate month filter
                    populateMonthFilterOptions(attendanceData);
                } else {
                    console.error('Failed to load attendance data:', response.status);
                    setDefaultValues();
                }
            } catch (error) {
                console.error('Error loading attendance data:', error);
                setDefaultValues();
            }
        }

        // Load overall percentage
        async function loadOverallPercentage() {
            try {
                const response = await fetch(`https://maxmocattendance-50029336824.development.catalystappsail.in/api/view-attendance/overall-percentage?id=${currentEmployeeId}`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('attendancePercentage').textContent = data.percentage + '%';
                } else {
                    document.getElementById('attendancePercentage').textContent = '0%';
                }
            } catch (error) {
                console.error('Error loading overall percentage:', error);
                document.getElementById('attendancePercentage').textContent = '0%';
            }
        }

        // Display today's time details
        function displayTodayTimeDetails(attendanceData) {
            const today = new Date().toISOString().split('T')[0];
            const todayRecord = attendanceData.find(record => record.date === today);

            if (todayRecord) {
                document.getElementById('checkInTime').textContent = todayRecord.checkinTime || '--:--';
                document.getElementById('checkOutTime').textContent = todayRecord.checkoutTime || '--:--';
                
                // Calculate total hours
                if (todayRecord.checkinTime && todayRecord.checkoutTime) {
                    const totalHours = calculateTotalHours(todayRecord.checkinTime, todayRecord.checkoutTime);
                    document.getElementById('totalHours').textContent = totalHours;
                } else {
                    document.getElementById('totalHours').textContent = '--:--';
                }
            } else {
                document.getElementById('checkInTime').textContent = '--:--';
                document.getElementById('checkOutTime').textContent = '--:--';
                document.getElementById('totalHours').textContent = '--:--';
            }

            // Set break time (static for now)
            document.getElementById('breakTime').textContent = '1h 00m';
        }

        // Calculate total hours between checkin and checkout
        function calculateTotalHours(checkinTime, checkoutTime) {
            try {
                const checkin = new Date('2000-01-01 ' + checkinTime);
                const checkout = new Date('2000-01-01 ' + checkoutTime);
                const diffMs = checkout - checkin;
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                return `${diffHours}h ${diffMinutes}m`;
            } catch (error) {
                console.error('Error calculating total hours:', error);
                return '--:--';
            }
        }

        // Set default values when data loading fails
        function setDefaultValues() {
            document.getElementById('attendancePercentage').textContent = '0%';
        }

        function setDefaultTodayValues() {
            document.getElementById('todayStatus').textContent = 'No Record';
            document.getElementById('checkInTime').textContent = '--:--';
            document.getElementById('checkOutTime').textContent = '--:--';
            document.getElementById('totalHours').textContent = '--:--';
            document.getElementById('breakTime').textContent = '--:--';
        }

        // Populate month filter dropdown
        function populateMonthFilterOptions(attendanceData) {
            const monthSelect = document.getElementById('monthSelect');
            const months = new Set();
            
            attendanceData.forEach(record => {
                if (record.date) {
                    const month = record.date.substring(0, 7); // YYYY-MM format
                    months.add(month);
                }
            });

            // Clear existing options
            monthSelect.innerHTML = '<option value="">Select Month</option>';
            
            // Add unique months
            Array.from(months).sort().reverse().forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = new Date(month + '-01').toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long' 
                });
                monthSelect.appendChild(option);
            });
        }

        // Handle filter type change
        function handleFilterTypeChange() {
            const filterType = document.getElementById('filterType').value;
            const dateRangeFilters = document.getElementById('dateRangeFilters');
            const monthFilter = document.getElementById('monthFilter');

            // Hide all filters first
            dateRangeFilters.style.display = 'none';
            monthFilter.style.display = 'none';

            // Show relevant filter
            if (filterType === 'date-range') {
                dateRangeFilters.style.display = 'flex';
            } else if (filterType === 'month') {
                monthFilter.style.display = 'block';
            }

            // If overall is selected, apply filter immediately
            if (filterType === 'overall') {
                applyFilter();
            }
        }

        // Apply filter based on selected type
        async function applyFilter() {
            const filterType = document.getElementById('filterType').value;
            let url = `https://maxmocattendance-50029336824.development.catalystappsail.in/api/view-attendance/filter/with-status-counts?id=${currentEmployeeId}`;

            if (filterType === 'date-range') {
                const fromDate = document.getElementById('fromDate').value;
                const toDate = document.getElementById('toDate').value;
                
                if (fromDate) url += `&fromDate=${fromDate}`;
                if (toDate) url += `&toDate=${toDate}`;
            } else if (filterType === 'month') {
                const selectedMonth = document.getElementById('monthSelect').value;
                if (selectedMonth) {
                    const fromDate = selectedMonth + '-01';
                    const lastDay = new Date(selectedMonth.split('-')[0], selectedMonth.split('-')[1], 0).getDate();
                    const toDate = selectedMonth + '-' + String(lastDay).padStart(2, '0');
                    url += `&fromDate=${fromDate}&toDate=${toDate}`;
                }
            }
            // For overall, no additional parameters needed

            try {
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Filtered data:', data);
                    
                    populateAttendanceTable(data.attendance);
                    updateStatusSummary(data.statusCounts, data.attendance.length);
                } else {
                    console.error('Failed to load filtered attendance data');
                    populateAttendanceTable([]);
                    updateStatusSummary({}, 0);
                }
            } catch (error) {
                console.error('Error loading filtered attendance data:', error);
                populateAttendanceTable([]);
                updateStatusSummary({}, 0);
            }
        }

        // Update status summary
        function updateStatusSummary(statusCounts, totalRecords) {
            document.getElementById('presentCount').textContent = statusCounts.present || 0;
            document.getElementById('absentCount').textContent = statusCounts.absent || 0;
            document.getElementById('lateCount').textContent = statusCounts.late || 0;
            document.getElementById('halfdayCount').textContent = statusCounts.halfday || 0;
            document.getElementById('permissionCount').textContent = statusCounts.permission || 0;
            document.getElementById('ondutyCount').textContent = statusCounts.onduty || 0;

            // Calculate percentage
            const presentDays = (statusCounts.present || 0) + (statusCounts.late || 0);
            const percentage = totalRecords > 0 ? Math.round((presentDays / totalRecords) * 100) : 0;
            document.getElementById('filteredPercentage').textContent = percentage + '%';
        }

        // Open attendance modal
        function openAttendanceModal() {
            document.getElementById('attendanceModal').style.display = 'block';
            // Apply default filter (overall)
            applyFilter();
        }

        // Close attendance modal
        function closeAttendanceModal() {
            document.getElementById('attendanceModal').style.display = 'none';
        }

        // Populate attendance table
        function populateAttendanceTable(data) {
            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = '';
            
            if (!data || data.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="5" style="text-align: center;">No attendance records found</td>';
                tbody.appendChild(row);
                return;
            }

            data.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.date ? new Date(record.date).toLocaleDateString('en-GB') : 'N/A'}</td>
                    <td>${record.checkinTime || '--:--'}</td>
                    <td>${record.checkoutTime || '--:--'}</td>
                    <td><span class="status-badge ${record.status ? record.status.toLowerCase() : ''}">${record.status || 'N/A'}</span></td>
                    <td>${record.reason || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Handle logout
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                sessionStorage.clear();
                window.location.href = 'index.html';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('attendanceModal');
            if (event.target === modal) {
                closeAttendanceModal();
            }
        }
    </script>
</body>
</html>