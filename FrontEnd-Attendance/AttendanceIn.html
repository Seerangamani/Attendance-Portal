<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Recognition Check-In</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 25%, #3d6db8 50%, #4a7bc8 75%, #5a8fd8 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            max-width: 1200px;
            width: 95%;
            height: 90vh;
            max-height: 800px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            display: flex;
            overflow: hidden;
        }
        
        .left-panel {
            flex: 1;
            padding: 30px;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .right-panel {
            flex: 1.5;
            padding: 30px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .back-button {
    position: absolute;
    top: 20px;
    left: 20px;
    background: rgba(255, 255, 255, 0.9);
    border: none;
    padding: 12px 16px;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    font-weight: 500;
    color: #333;
}

.back-button:hover {
    background: rgba(255, 255, 255, 1);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
}

.back-button .arrow {
    font-size: 16px;
    transition: transform 0.3s ease;
}

.back-button:hover .arrow {
    transform: translateX(-3px);
}
        .employee-face-section {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .employee-face-section h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 18px;
        }
        
        #employee-face-image {
            border-radius: 75px;
            border: 3px solid #e9ecef;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        #employee-info {
            margin-top: 15px;
            font-size: 14px;
            color: #666;
            line-height: 1.4;
        }
        
        .attendance-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .attendance-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .card-title {
            color: #333;
            margin: 0 0 10px 0;
            font-size: 28px;
        }
        
        .card-description {
            color: #666;
            margin: 0 0 20px 0;
            font-size: 16px;
        }
        
        .current-time {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .time-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .time-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .camera-container {
            position: relative;
            width: 100%;
            max-width: 350px;
            margin: 0 auto 20px;
            border-radius: 15px;
            overflow: hidden;
            background: #000;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        
        #video {
            width: 100%;
            height: 260px;
            object-fit: cover;
        }
        
        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            text-align: center;
            padding: 20px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .start-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
        }
        
        .start-button:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 123, 255, 0.4);
        }
        
        .start-button:nth-child(2) {
            background: #dc3545;
            box-shadow: 0 4px 10px rgba(220, 53, 69, 0.3);
        }
        
        .start-button:nth-child(2):hover {
            background: #c82333;
            box-shadow: 0 6px 15px rgba(220, 53, 69, 0.4);
        }
        
        .start-button:nth-child(3) {
            background: #28a745;
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3);
        }
        
        .start-button:nth-child(3):hover {
            background: #218838;
            box-shadow: 0 6px 15px rgba(40, 167, 69, 0.4);
        }
        
        .hidden {
            display: none !important;
        }
        
        .matched-employee-info {
            background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%);
            border: 2px solid #10b981;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            display: none;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);
        }
        
        .matched-employee-info.show {
            display: block;
            animation: slideIn 0.5s ease-out;
        }
        
        .matched-employee-info h4 {
            margin: 0 0 10px 0;
            color: #047857;
            font-size: 16px;
            font-weight: bold;
        }
        
        .matched-employee-info div {
            font-size: 14px;
            color: #065f46;
            line-height: 1.4;
        }
        
        .success-message {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 2px solid #28a745;
            color: #155724;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);
            display: none;
        }
        
        .success-message.show {
            display: block;
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .success-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .success-time {
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .success-note {
            font-size: 14px;
            color: #0f5132;
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: 95vh;
                width: 98%;
            }
            
            .left-panel, .right-panel {
                flex: 1;
                padding: 20px;
            }
            
            .employee-face-section {
                margin-bottom: 20px;
                padding: 15px;
            }
            
            #employee-face-image {
                width: 120px;
                height: 120px;
            }
            
            #video {
                height: 200px;
            }
            
            .card-title {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <button class="back-button" onclick="goBack()">
        <span class="arrow">‚Üê</span>
        <span>Back</span>
    </button>
    <div class="container">
        <!-- Left Panel - Employee Info -->
        <div class="left-panel">
            <div class="employee-face-section">
                <h3>Employee Face Image</h3>
                <img id="employee-face-image" alt="Employee Face" width="150" height="150" />
                <div id="employee-info"></div>
            </div>
            
            <!-- Current Time Display -->
            <div class="current-time">
                <div class="time-label">Current Time</div>
                <div class="time-value" id="current-time"></div>
            </div>

            <!-- Dynamic Shift Timing Display -->
            <div class="shift-timing">
                <div class="timing-label">Your Shift Timing</div>
                <div class="timing-value" id="shift-timing">Loading...</div>
                <div class="gender-info" id="gender-info"></div>
                <div class="grace-info" id="grace-info"></div>
            </div>

            <!-- Status Check Info -->
            <div id="status-check-info" class="status-check-info hidden">
                <h4>üìã Attendance Status Check</h4>
                <div id="status-check-details"></div>
            </div>

            <!-- Matched Employee Info (for public users) -->
            <div id="matched-employee-info" class="matched-employee-info hidden">
                <h4>‚úÖ Face Matched!</h4>
                <div id="matched-employee-details"></div>
            </div>
        </div>

        <!-- Right Panel - Face Recognition Interface -->
        <div class="right-panel">
            <div class="attendance-header">
                <div class="attendance-icon">üë§</div>
                <h2 class="card-title" id="mode-title">Face Recognition Attendance</h2>
                <p class="card-description" id="mode-description">Look at the camera to automatically mark attendance</p>
            </div>

            <!-- Camera Feed -->
            <div class="camera-container">
                <video id="video" autoplay muted></video>
                <div id="camera-overlay" class="camera-overlay">Click "Begin Face Recognition" to start</div>
            </div>

            <!-- Action Buttons -->
            <div class="button-group">
                <button id="start-camera-btn" onclick="startCamera()" class="start-button">üë§ Begin Face Recognition</button>
                <button id="stop-camera-btn" onclick="stopCamera()" class="start-button hidden">‚èπÔ∏è Stop Camera</button>
                <button id="capture-button" onclick="captureAndProcessAttendance()" class="start-button hidden">
                    <span id="capture-button-text">üì∏ Capture & Mark Attendance</span>
                </button>
            </div>

            <!-- Grace Time Info -->
            <div id="grace-time-info" class="info-message hidden">
                <div class="info-title">‚è∞ Grace Time Information</div>
                <div id="grace-time-details"></div>
            </div>

            <!-- Time Validation Warning -->
            <div id="timing-warning" class="warning-message hidden">
                <div class="warning-title">‚è∞ Outside Shift Hours</div>
                <div id="timing-warning-details"></div>
            </div>

            <!-- Messages -->
            <div id="success-message" class="success-message hidden">
                <div class="success-title" id="success-title">‚úÖ Successfully Processed!</div>
                <div class="success-time">Time: <span id="action-time"></span></div>
                <div class="success-details" id="success-details"></div>
                <div class="success-note" id="success-note">Have a great day!</div>
            </div>

            <div id="error-message" class="error-message hidden">
                <div class="error-title">‚ùå Action Failed</div>
                <div id="error-details"></div>
            </div>

            <div id="warning-message" class="warning-message hidden">
                <div class="warning-title">‚ö†Ô∏è Attendance Issue</div>
                <div id="warning-details"></div>
            </div>
        </div>
    </div>

<script>
   // Updated JavaScript code for attendance management with Permission and Half Day Leave logic

   const sessionCheck = validateSession();
if (!sessionCheck.isValid) {
  alert("Employee session not found. Please login again.");
  window.location.href = "index.html";
}


let videoStream;
let matchedEmployee = null;
let currentEmployeeData = null;
let attendanceStatus = null;

const video = document.getElementById('video');
const overlay = document.getElementById('camera-overlay');
const startBtn = document.getElementById('start-camera-btn');
const stopBtn = document.getElementById('stop-camera-btn');
const captureBtn = document.getElementById('capture-button');
const captureButtonText = document.getElementById('capture-button-text');
const successMsg = document.getElementById('success-message');
const errorMsg = document.getElementById('error-message');
const warningMsg = document.getElementById('warning-message');
const timingWarning = document.getElementById('timing-warning');
const graceTimeInfo = document.getElementById('grace-time-info');
const actionTime = document.getElementById('action-time');
const employeeFaceImage = document.getElementById('employee-face-image');
const employeeInfo = document.getElementById('employee-info');
const matchedEmployeeInfo = document.getElementById('matched-employee-info');
const matchedEmployeeDetails = document.getElementById('matched-employee-details');
const statusCheckInfo = document.getElementById('status-check-info');
const statusCheckDetails = document.getElementById('status-check-details');
const shiftTiming = document.getElementById('shift-timing');
const genderInfo = document.getElementById('gender-info');
const graceInfo = document.getElementById('grace-info');
const modeTitle = document.getElementById('mode-title');
const modeDescription = document.getElementById('mode-description');
const successTitle = document.getElementById('success-title');
const successDetails = document.getElementById('success-details');
const successNote = document.getElementById('success-note');

const employeeId = sessionStorage.getItem("employeeId");
const employeeName = sessionStorage.getItem("employeeName");
const department = sessionStorage.getItem("department");
const usertype = sessionStorage.getItem("usertype");

// API Base URL - ensure this matches your Spring Boot server
const API_BASE_URL = 'https://maxmocattendance-50029336824.development.catalystappsail.in';

if (!employeeId || !employeeName || !department) {
    alert("Employee session not found. Please login again.");
    window.location.href = "index.html";
} else {
    if (usertype === "public") {
        employeeFaceImage.src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDE1MCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNTAiIGhlaWdodD0iMTUwIiBmaWxsPSIjRjVGNUY1Ii8+CjxjaXJjbGUgY3g9Ijc1IiBjeT0iNjAiIHI9IjI1IiBmaWxsPSIjQ0NDIi8+CjxwYXRoIGQ9Ik0zMCAxMjBDMzAgMTAwIDUwIDkwIDc1IDkwQzEwMCA5MCA4MjAgMTAwIDEyMCAxMjBWMTUwSDMwVjEyMFoiIGZpbGw9IiNDQ0MiLz4KPC9zdmc+";
        employeeInfo.textContent = "Public Access - Face will be matched against all employees";
        shiftTiming.textContent = "Will be determined after face recognition";
        genderInfo.textContent = "Gender-based timing will be applied automatically";
        graceInfo.textContent = "Grace time: 30 minutes from official start";
    } else {
        loadEmployeeData();
    }
}

function updateTime() {
    document.getElementById('current-time').textContent = new Date().toLocaleTimeString();
}
setInterval(updateTime, 1000);
updateTime();

async function loadEmployeeData() {
    try {
        const response = await fetch(`${API_BASE_URL}/api/employee/${employeeId}`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const employee = await response.json();
            currentEmployeeData = employee;
            
            try {
                const faceResponse = await fetch(`${API_BASE_URL}/api/employee/face-image/${employeeId}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                if (faceResponse.ok) {
                    const data = await faceResponse.json();
                    employeeFaceImage.src = `data:image/jpeg;base64,${data.base64Image}`;
                }
            } catch (faceErr) {
                console.log('Face image not available');
                employeeFaceImage.alt = "Face image not available";
            }
            
            employeeInfo.textContent = `Employee: ${employee.username || employeeName} | Department: ${employee.department || department}`;
            await displayTimingInfo(employee);
        } else {
            console.log('Using session data as fallback');
            currentEmployeeData = {
                id: employeeId,
                username: employeeName,
                department: department,
                gender: 'MALE'
            };
            
            employeeInfo.textContent = `Employee: ${employeeName} | Department: ${department}`;
            await displayTimingInfo(currentEmployeeData);
        }
        
    } catch (err) {
        console.error('Error loading employee data:', err);
        currentEmployeeData = {
            id: employeeId,
            username: employeeName,
            department: department,
            gender: 'MALE'
        };
        
        employeeFaceImage.alt = "Image not found";
        employeeInfo.textContent = `Employee: ${employeeName} | Department: ${department}`;
        await displayTimingInfo(currentEmployeeData);
    }
}

async function displayTimingInfo(employee) {
    // Check if employee has any special allocation (Permission or Half Day Leave) for today
    const specialAllocation = await checkSpecialAllocation(employee.id);
    
    let timing;
    if (specialAllocation) {
        timing = getSpecialAllocationInfo(employee.id, employee.gender, specialAllocation);
    } else {
        timing = getEmployeeTimingInfo(employee.id, employee.gender);
    }
    
    shiftTiming.textContent = timing.shiftTiming;
    genderInfo.textContent = `Gender: ${employee.gender || 'Not specified'} | ${timing.description}`;
    graceInfo.textContent = `Grace Period: ${timing.gracePeriod} | Late after: ${timing.lateThreshold}`;
    
    // Show grace time info
    let graceDetails = `
        <div><strong>Employee ID:</strong> ${employee.id}</div>
        <div><strong>Official Start:</strong> ${timing.officialStart}</div>
        <div><strong>Grace Until:</strong> ${timing.lateThreshold}</div>
        <div><strong>Work Hours:</strong> ${timing.shiftTiming}</div>
        <div><strong>Policy:</strong> ${timing.description}</div>
    `;
    
    if (specialAllocation) {
        graceDetails += `
            <div style="margin-top: 10px; padding: 10px; background-color: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
                <strong>‚ö†Ô∏è Special Allocation Today:</strong><br>
                <strong>Status:</strong> ${specialAllocation.status}<br>
                ${specialAllocation.status === 'Permission' ? 
                    `<strong>Permission Time:</strong> ${formatTimeFromDB(specialAllocation.permissionFrom)} - ${formatTimeFromDB(specialAllocation.permissionTo)}` :
                    `<strong>Half Day Time:</strong> ${formatTimeFromDB(specialAllocation.halfdayFrom)} - ${formatTimeFromDB(specialAllocation.halfdayTo)}`
                }
            </div>
        `;
    }
    
    document.getElementById('grace-time-details').innerHTML = graceDetails;
    graceTimeInfo.classList.remove('hidden');
}

async function checkSpecialAllocation(empId) {
    try {
        const today = new Date().toISOString().split('T')[0];
        const response = await fetch(`${API_BASE_URL}/api/attendance/status/${empId}/${today}`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            
            // Check if employee has Permission or Half Day Leave allocation
            if (data.status === 'Permission' && data.permissionFrom && data.permissionTo) {
                return {
                    status: 'Permission',
                    permissionFrom: data.permissionFrom,
                    permissionTo: data.permissionTo
                };
            } else if (data.status === 'Half Day Leave' && data.halfdayFrom && data.halfdayTo) {
                return {
                    status: 'Half Day Leave',
                    halfdayFrom: data.halfdayFrom,
                    halfdayTo: data.halfdayTo
                };
            }
        }
    } catch (err) {
        console.log('No special allocation found for today');
    }
    return null;
}

function getSpecialAllocationInfo(empId, gender, allocation) {
    const baseInfo = getEmployeeTimingInfo(empId, gender);
    
    if (allocation.status === 'Permission') {
        return {
            ...baseInfo,
            shiftTiming: `Permission Allocated: ${formatTimeFromDB(allocation.permissionFrom)} - ${formatTimeFromDB(allocation.permissionTo)}`,
            description: `Permission allocated - Come within allocated time to maintain Permission status`,
            gracePeriod: "As per allocated time",
            lateThreshold: formatTimeFromDB(allocation.permissionTo),
            specialAllocation: allocation
        };
    } else if (allocation.status === 'Half Day Leave') {
        return {
            ...baseInfo,
            shiftTiming: `Half Day Allocated: ${formatTimeFromDB(allocation.halfdayFrom)} - ${formatTimeFromDB(allocation.halfdayTo)}`,
            description: `Half Day Leave allocated - Come within allocated time to maintain Half Day status`,
            gracePeriod: "As per allocated time",
            lateThreshold: formatTimeFromDB(allocation.halfdayTo),
            specialAllocation: allocation
        };
    }
    
    return baseInfo;
}

function formatTimeFromDB(timeString) {
    if (!timeString) return 'Not set';
    
    // Handle different time formats from database
    let time;
    if (timeString.includes('T')) {
        // ISO format: 2024-01-01T09:30:00
        time = new Date(timeString);
    } else if (timeString.includes(':')) {
        // Time format: 09:30:00 or 09:30
        const today = new Date();
        const [hours, minutes] = timeString.split(':');
        time = new Date(today.getFullYear(), today.getMonth(), today.getDate(), parseInt(hours), parseInt(minutes));
    } else {
        return timeString; // Return as-is if format not recognized
    }
    
    return time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function getEmployeeTimingInfo(empId, gender) {
    // Special timing for mmw027
  if (empId === "mmw027") {
        return {
            officialStart: "9:40 AM",
            gracePeriod: "No grace period", // ‚Üê Fixed: Honest about no grace
            lateThreshold: "9:40 AM",
            shiftTiming: "9:40 AM - 4:00 PM (No grace period)",
            description: "Special timing - No grace period allowed",
            startTime: { hour: 9, minute: 40 },
            endTime: { hour: 16, minute: 0 },
            graceMinutes: 0,
            isSpecialEmployee: true
        };
    }
    
    // Standard timing with 9:00 AM start and 30-minute grace
    const officialStart = "9:00 AM";
    const gracePeriod = "30 minutes";
    const lateThreshold = "9:30 AM";
    
    if (gender && (gender.toUpperCase() === "FEMALE" || gender.toUpperCase() === "F")) {
        return {
            officialStart: officialStart,
            gracePeriod: gracePeriod,
            lateThreshold: lateThreshold,
            shiftTiming: "9:00 AM - 5:00 PM (Grace until 9:30 AM)",
            description: "Female employee timing (8 hours work)",
            startTime: { hour: 9, minute: 0 },
            endTime: { hour: 17, minute: 0 },
            graceMinutes: 30,
            isSpecialEmployee: false
        };
    } else {
        return {
            officialStart: officialStart,
            gracePeriod: gracePeriod,
            lateThreshold: lateThreshold,
            shiftTiming: "9:00 AM - 6:00 PM (Grace until 9:30 AM)",
            description: "Male employee timing (9 hours work)",
            startTime: { hour: 9, minute: 0 },
            endTime: { hour: 18, minute: 0 },
            graceMinutes: 30,
            isSpecialEmployee: false
        };
    }
}

async function validateAttendanceTime(empId, gender) {
    const now = new Date();
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();
    const currentTime = currentHour * 60 + currentMinute;
    
    // Check for special allocation first
    const specialAllocation = await checkSpecialAllocation(empId);
    
    let validation = {
        isValid: true,
        message: '',
        timing: '',
        currentTime: formatTime(currentTime),
        status: 'Present',
        isLate: false,
        needsStatusCheck: false,
        hasSpecialAllocation: !!specialAllocation
    };
    
    if (specialAllocation) {
        // Handle special allocations (Permission/Half Day)...
        // ... existing special allocation logic
    } else {
        // Normal timing validation
        const timingInfo = getEmployeeTimingInfo(empId, gender);
        validation.timing = timingInfo.shiftTiming;
        
        if (empId === "mmw027") {
            // Special employee timing
            const officialStartTime = 9 * 60 + 40; // 9:40 AM
            const graceEndTime = officialStartTime + timingInfo.graceMinutes; // Add grace minutes
            
            if (currentTime > graceEndTime) {
                validation.isLate = true;
                validation.needsStatusCheck = true;
                validation.message = `Late arrival (after ${formatTime(graceEndTime)}). Checking employee status to mark as Late.`;
            } else if (currentTime > officialStartTime && timingInfo.graceMinutes > 0) {
                validation.message = `Within grace period - attendance will be marked as Present`;
            } else if (currentTime <= officialStartTime) {
                validation.message = 'On time - attendance will be marked as Present';
            } else {
                // No grace period case
                validation.isLate = true;
                validation.needsStatusCheck = true;
                validation.message = `Late arrival (after 9:40 AM - no grace period). Checking employee status to mark as Late.`;
            }
        } else {
            // Standard employees logic remains the same...
            const graceEndTime = 9 * 60 + 30; // 9:30 AM in minutes
            if (currentTime > graceEndTime) {
                validation.isLate = true;
                validation.needsStatusCheck = true;
                validation.message = `Late arrival (after grace period). Checking if employee status is Absent/Permission to mark as Late.`;
            } else {
                validation.message = 'Within grace period - attendance will be marked as Present';
            }
        }
    }
    
    return validation;
}

function parseTimeFromDB(timeString) {
    if (!timeString) return 0;
    
    let hours, minutes;
    
    if (timeString.includes('T')) {
        // ISO format: 2024-01-01T09:30:00
        const date = new Date(timeString);
        hours = date.getHours();
        minutes = date.getMinutes();
    } else if (timeString.includes(':')) {
        // Time format: 09:30:00 or 09:30
        const parts = timeString.split(':');
        hours = parseInt(parts[0]);
        minutes = parseInt(parts[1]);
    } else {
        return 0;
    }
    
    return hours * 60 + minutes;
}

function formatTime(minutes) {
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    const ampm = hours >= 12 ? 'PM' : 'AM';
    const displayHours = hours > 12 ? hours - 12 : (hours === 0 ? 12 : hours);
    return `${displayHours}:${mins.toString().padStart(2, '0')} ${ampm}`;
}

async function checkEmployeeStatus(empId) {
    try {
        const today = new Date().toISOString().split('T')[0];
        const response = await fetch(`${API_BASE_URL}/api/attendance/employee-status/${empId}/${today}`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        });
        if (response.ok) {
            const data = await response.json();
            return data;
        }
    } catch (err) {
        console.log('Employee status check not available via API');
    }
    return null;
}

async function startCamera() {
    try {
        videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = videoStream;
        overlay.classList.add('hidden');
        startBtn.classList.add('hidden');
        stopBtn.classList.remove('hidden');
        captureBtn.classList.remove('hidden');
        
        hideAllMessages();
    } catch (err) {
        alert('Camera access error: ' + err.message);
    }
}

function stopCamera() {
    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
    }
    overlay.classList.remove('hidden');
    startBtn.classList.remove('hidden');
    stopBtn.classList.add('hidden');
    captureBtn.classList.add('hidden');
    hideAllMessages();
}

function hideAllMessages() {
    successMsg.classList.add('hidden');
    errorMsg.classList.add('hidden');
    warningMsg.classList.add('hidden');
    timingWarning.classList.add('hidden');
    statusCheckInfo.classList.add('hidden');
    matchedEmployeeInfo.classList.add('hidden');
}

function captureBase64Only() {
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    const fullData = canvas.toDataURL('image/jpeg');
    return fullData.split(',')[1];
}

async function captureAndProcessAttendance() {
    try {
        // Validate session before processing - with more flexible validation
        const sessionCheck = validateSession();
        if (!sessionCheck.isValid) {
            // Show error message instead of alert and don't auto-redirect
            hideAllMessages();
            errorMsg.classList.remove('hidden');
            document.getElementById('error-details').innerHTML = `
                <div>Session expired or invalid.</div>
                <div style="margin-top: 10px;">
                    <button onclick="redirectToLogin()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                        Go to Login
                    </button>
                    <button onclick="retryWithCurrentSession()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-left: 10px;">
                        Retry
                    </button>
                </div>
            `;
            return;
        }

        hideAllMessages();
        
        statusCheckInfo.classList.remove('hidden');
        statusCheckDetails.innerHTML = '<div>üîç Processing face recognition...</div>';
        
        const base64Image = captureBase64Only();
        const now = new Date();
        const { employeeId, employeeName, department, usertype } = sessionCheck.data;

        // First, perform face recognition
        const faceResponse = await fetch(`${API_BASE_URL}/api/face-recognition`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                employeeId: employeeId,
                liveImage: base64Image
            })
        });

        if (!faceResponse.ok) {
            throw new Error(`Face recognition failed: HTTP ${faceResponse.status}`);
        }

        const faceResult = await faceResponse.json();

        if (faceResult.status !== "matched") {
            hideAllMessages();
            errorMsg.classList.remove('hidden');
            document.getElementById('error-details').textContent = faceResult.message || "Face not matched";
            return;
        }

        let targetEmployee = currentEmployeeData;
        let targetEmployeeId = employeeId;
        
        // Handle public user face matching
        if (usertype === "public" && faceResult.employee) {
            targetEmployeeId = faceResult.employee.id;
            matchedEmployee = faceResult.employee;
            
            const empResponse = await fetch(`${API_BASE_URL}/api/employee/${targetEmployeeId}`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });
            if (empResponse.ok) {
                targetEmployee = await empResponse.json();
                await displayTimingInfo(targetEmployee);
            }

            if (faceResult.employee.faceImage) {
                employeeFaceImage.src = `data:image/jpeg;base64,${faceResult.employee.faceImage}`;
            }

            matchedEmployeeDetails.innerHTML = `
                <strong>Name:</strong> ${faceResult.employee.name}<br>
                <strong>Department:</strong> ${faceResult.employee.department}<br>
                <strong>Employee ID:</strong> ${faceResult.employee.id}<br>
                <strong>Gender:</strong> ${targetEmployee?.gender || 'Not specified'}<br>
                <strong>Shift:</strong> ${getEmployeeTimingInfo(faceResult.employee.id, targetEmployee?.gender).shiftTiming}
            `;
            matchedEmployeeInfo.classList.remove('hidden');
            employeeInfo.textContent = `Matched: ${faceResult.employee.name} | Department: ${faceResult.employee.department}`;
        }

        // Check if attendance is already marked
        statusCheckDetails.innerHTML = '<div>üìã Checking attendance status...</div>';
        
        try {
            const today = new Date().toISOString().split('T')[0];
            const attendanceCheckResponse = await fetch(`${API_BASE_URL}/api/attendance/status/${targetEmployeeId}/${today}`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });
            
            if (attendanceCheckResponse.ok) {
                const attendanceData = await attendanceCheckResponse.json();
                
                if (attendanceData.hasCheckedIn) {
                    hideAllMessages();
                    successMsg.classList.remove('hidden');
                    actionTime.textContent = new Date(attendanceData.checkinTime).toLocaleTimeString();
                    successTitle.textContent = '‚úÖ Attendance Already Marked!';
                    successDetails.textContent = `Status: ${attendanceData.status || 'Present'} | Checked in at: ${new Date(attendanceData.checkinTime).toLocaleTimeString()}`;
                    successNote.textContent = 'Your attendance for today has already been recorded.';
                    stopCamera();
                    return;
                }
            }
        } catch (statusErr) {
            console.log('Could not check attendance status via API, proceeding with attendance marking');
        }

        // Validate timing and process attendance
        statusCheckDetails.innerHTML = '<div>üìã Validating timing and processing attendance...</div>';
        
        const timingValidation = await validateAttendanceTime(targetEmployeeId, targetEmployee?.gender);
        
        // Show timing validation info
        if (timingValidation.hasSpecialAllocation) {
            statusCheckDetails.innerHTML = `
                <div>üìã Special allocation detected!</div>
                <div>‚è∞ ${timingValidation.message}</div>
                <div>üïê Current: ${timingValidation.currentTime} | Expected: ${timingValidation.timing}</div>
            `;
        } else {
            statusCheckDetails.innerHTML = `
                <div>üìã Processing regular attendance...</div>
                <div>‚è∞ ${timingValidation.message}</div>
            `;
        }
        
        // Process attendance - the backend will handle all the logic
        await processAttendance(targetEmployeeId, now);

    } catch (error) {
        hideAllMessages();
        errorMsg.classList.remove('hidden');
        document.getElementById('error-details').textContent = "Error: " + error.message;
        console.error('Process error:', error);
    }
}

// Helper functions for session handling
function redirectToLogin() {
    window.location.href = "index.html";
}

function retryWithCurrentSession() {
    // Try to reload employee data and retry
    const sessionCheck = validateSession();
    if (sessionCheck.isValid) {
        hideAllMessages();
        const { usertype } = sessionCheck.data;
        if (usertype === "public") {
            employeeFaceImage.src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDE1MCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi0vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNTAiIGhlaWdodD0iMTUwIiBmaWxsPSIjRjVGNUY1Ii8+CjxjaXJjbGUgY3g9Ijc1IiBjeT0iNjAiIHI9IjI1IiBmaWxsPSIjQ0NDIi8+CjxwYXRoIGQ9Ik0zMCAxMjBDMzAgMTAwIDUwIDkwIDc1IDkwQzEwMCA5MCA4MjAgMTAwIDEyMCAxMjBWMTUwSDMwVjEyMFoiIGZpbGw9IiNDQ0MiLz4KPC9zdmc+";
            employeeInfo.textContent = "Public Access - Face will be matched against all employees";
            shiftTiming.textContent = "Will be determined after face recognition";
            genderInfo.textContent = "Gender-based timing will be applied automatically";
            graceInfo.textContent = "Grace time: 30 minutes from official start";
        } else {
            loadEmployeeData();
        }
    } else {
        redirectToLogin();
    }
}

// Debug function to check session storage
function debugSessionStorage() {
    console.log('=== Session Storage Debug ===');
    console.log('employeeId:', sessionStorage.getItem("employeeId"));
    console.log('employeeName:', sessionStorage.getItem("employeeName"));
    console.log('department:', sessionStorage.getItem("department"));
    console.log('usertype:', sessionStorage.getItem("usertype"));
    console.log('All session storage keys:', Object.keys(sessionStorage));
    console.log('Session storage length:', sessionStorage.length);
    console.log('=============================');
}
// Updated page initialization - replace the original session check
function initializePage() {
    const sessionCheck = validateSession();
    console.log('Page initialization session check:', sessionCheck);
    
    if (!sessionCheck.isValid) {
        console.log('Session invalid, showing login prompt');
        // Show error in the existing error message area instead of replacing entire body
        hideAllMessages();
        errorMsg.classList.remove('hidden');
        document.getElementById('error-details').innerHTML = `
            <div><strong>Session Error:</strong> Please login to continue</div>
            <div style="margin-top: 10px;">
                <button onclick="window.location.href='index.html'" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                    Go to Login
                </button>
                <button onclick="checkSessionAgain()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-left: 10px;">
                    Refresh Session
                </button>
            </div>
        `;
        return;
    }
    
    const { employeeId, employeeName, department, usertype } = sessionCheck.data;
    console.log('Session valid, initializing with:', { employeeId, employeeName, department, usertype });
    
    if (usertype === "public") {
        employeeFaceImage.src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDE1MCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNTAiIGhlaWdodD0iMTUwIiBmaWxsPSIjRjVGNUY1Ii8+CjxjaXJjbGUgY3g9Ijc1IiBjeT0iNjAiIHI9IjI1IiBmaWxsPSIjQ0NDIi8+CjxwYXRoIGQ9Ik0zMCAxMjBDMzAgMTAwIDUwIDkwIDc1IDkwQzEwMCA5MCA4MjAgMTAwIDEyMCAxMjBWMTUwSDMwVjEyMFoiIGZpbGw9IiNDQ0MiLz4KPC9zdmc+";
        employeeInfo.textContent = "Public Access - Face will be matched against all employees";
        shiftTiming.textContent = "Will be determined after face recognition";
        genderInfo.textContent = "Gender-based timing will be applied automatically";
        graceInfo.textContent = "Grace time: 30 minutes from official start";
    } else {
        loadEmployeeData();
    }
}

function checkSessionAgain() {
    console.log('Rechecking session...');
    hideAllMessages();
    initializePage();
}

// Update the initial session check (replace the existing one)
const initialSessionCheck = validateSession();
if (!initialSessionCheck.isValid) {
    // Show a more user-friendly error
    document.body.innerHTML = `
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-family: Arial, sans-serif;">
            <div style="text-align: center; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
                <h3>Session Expired</h3>
                <p>Please login again to continue</p>
                <button onclick="window.location.href='index.html'" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                    Go to Login
                </button>
            </div>
        </div>
    `;
} else {
    const { employeeId, employeeName, department, usertype } = initialSessionCheck.data;
    
    if (usertype === "public") {
        employeeFaceImage.src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDE1MCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNTAiIGhlaWdodD0iMTUwIiBmaWxsPSIjRjVGNUY1Ii8+CjxjaXJjbGUgY3g9Ijc1IiBjeT0iNjAiIHI9IjI1IiBmaWxsPSIjQ0NDIi8+CjxwYXRoIGQ9Ik0zMCAxMjBDMzAgMTAwIDUwIDkwIDc1IDkwQzEwMCA5MCA4MjAgMTAwIDEyMCAxMjBWMTUwSDMwVjEyMFoiIGZpbGw9IiNDQ0MiLz4KPC9zdmc+";
        employeeInfo.textContent = "Public Access - Face will be matched against all employees";
        shiftTiming.textContent = "Will be determined after face recognition";
        genderInfo.textContent = "Gender-based timing will be applied automatically";
        graceInfo.textContent = "Grace time: 30 minutes from official start";
    } else {
        loadEmployeeData();
    }
}

async function processAttendance(empId, timestamp) {
    try {
        console.log('Sending attendance request:', {
            employeeId: empId,
            time: timestamp.toISOString()
        });

        const response = await fetch(`${API_BASE_URL}/api/attendance/checkin`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                employeeId: empId,
                time: timestamp.toISOString()
            })
        });

        console.log('Response status:', response.status);

        let result;
        try {
            result = await response.json();
        } catch (jsonErr) {
            const textResponse = await response.text();
            console.error('Failed to parse JSON response:', textResponse);
            throw new Error(`Server returned invalid JSON. Status: ${response.status}, Response: ${textResponse}`);
        }

        handleAttendanceResponse(response, result, timestamp);

    } catch (error) {
        console.error('Attendance processing error:', error);
        hideAllMessages();
        errorMsg.classList.remove('hidden');
        document.getElementById('error-details').textContent = "Attendance error: " + error.message;
    }
}

function handleAttendanceResponse(response, result, timestamp) {
    hideAllMessages();
    
    if (response.ok) {
        actionTime.textContent = timestamp.toLocaleTimeString();
        successTitle.textContent = '‚úÖ Attendance Processed Successfully!';
        
        let statusMessage = `Status: ${result.status || 'Present'}`;
        if (result.message) {
            statusMessage += ` | ${result.message}`;
        }
        
        successDetails.textContent = `Employee attendance marked using face recognition | ${statusMessage}`;
        
        // Customize success note based on status
        switch(result.status) {
            case 'Permission':
                successNote.textContent = 'Permission status maintained. Enjoy your allocated time!';
                break;
            case 'Half Day Leave':
                successNote.textContent = 'Half Day Leave status maintained. Have a good day!';
                break;
            case 'Late':
                successNote.textContent = 'Late arrival recorded. Please try to arrive within the allocated time next time.';
                break;
            case 'Absent':
                successNote.textContent = 'Marked as Absent due to arrival outside allocated time.';
                break;
            default:
                successNote.textContent = 'Welcome! Have a productive day ahead!';
        }
        
        successMsg.classList.remove('hidden');
        stopCamera();
    } else {
        if (result.message && result.message.toLowerCase().includes('already')) {
            successTitle.textContent = '‚úÖ Attendance Already Marked!';
            successDetails.textContent = 'Your attendance for today has already been recorded.';
            successNote.textContent = 'Thank you! Your attendance is confirmed.';
            successMsg.classList.remove('hidden');
            stopCamera();
        } else {
            errorMsg.classList.remove('hidden');
            document.getElementById('error-details').textContent = result.message || "Attendance marking failed";
        }
    }
}

function goBack() {
    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
    }
    window.location.href = "EmployeeAttendance.html";
}

function validateSession() {
    try {
        const employeeId = sessionStorage.getItem("employeeId");
        const employeeName = sessionStorage.getItem("employeeName");
        const department = sessionStorage.getItem("department");
        const usertype = sessionStorage.getItem("usertype");
        
        console.log('Session check:', { employeeId, employeeName, department, usertype });
        
        // For public users, we only need employeeId to be set and usertype to be "public"
        if (usertype === "public") {
            // Public users can have minimal session data
            return {
                isValid: !!(employeeId && usertype === "public"),
                data: { 
                    employeeId: employeeId || "Pub01", 
                    employeeName: employeeName || "Public User", 
                    department: department || "Public", 
                    usertype 
                }
            };
        }
        
        // For regular users, we need all core fields
        const isValid = !!(employeeId && employeeName && department);
        return {
            isValid: isValid,
            data: { employeeId, employeeName, department, usertype: usertype || "employee" }
        };
    } catch (error) {
        console.error('Session validation error:', error);
        return {
            isValid: false,
            data: {}
        };
    }
}
initializePage();

window.addEventListener('beforeunload', function() {
    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
    }
});
</script>
</body>
</html>